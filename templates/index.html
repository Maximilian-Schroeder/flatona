<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>flatona</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5/main.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="d-flex flex-column min-vh-100">
{% extends "base.html" %}

{% block title %}Kalender - flatona{% endblock %}

{% block content %}


<div class="container">

  <!-- Formular zum Hinzuf√ºgen von Events -->
  <div id="eventModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>

      <h3>Neues Event erstellen</h3>
      <form id="eventForm">
        <label for="title">Titel</label>
        <input type="text" id="title" placeholder="Titel" required>

        <label for="start">Startdatum</label>
        <input type="text" id="start" placeholder="Startdatum" required>

        <label for="end">Enddatum</label>
        <input type="text" id="end" placeholder="Enddatum">

        <label for="persons">Personen</label>
          <select id="persons" multiple size="4">
            <option value="Jasmin">Jasmin</option>
            <option value="Lea">Lea</option>
            <option value="Maxi">Maxi</option>
            <option value="Satya">Satya</option>
            <option value="Sophia">Sophia</option>
          </select>
        <button type="submit">Speichern</button>
      </form>
  </div>
  </div>

  <!-- Kalenderbereich -->
  <div id='calendar-container'>
    <div id='calendar'></div>
  </div>

      <div class="text-center my-1">
      <button id="openFormBtn" class="btn btn-primary btn-lg">
      Neuer Termin
      </button>
    </div>

</div>
  {% endblock %}

  {% block scripts %}
  <script>
    // --- Flatpickr ---
    flatpickr("#start", { dateFormat: "Y-m-d", defaultDate: new Date() });
    flatpickr("#end", { dateFormat: "Y-m-d" });

    // --- Choices.js ---
    const personsSelect = document.getElementById('persons');
    const choices = new Choices(personsSelect, { removeItemButton: true });

    // --- Modal Logik ---
    const modal = document.getElementById("eventModal");
    const btn = document.getElementById("openFormBtn");
    const span = document.getElementById("closeModal");

    btn.onclick = () => modal.style.display = "block";
    span.onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if(event.target == modal) modal.style.display = "none"; }

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      const isMobile = window.innerWidth < 768;

      var calendar = new FullCalendar.Calendar(calendarEl, {
        themeSystem: 'bootstrap5',
        //initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        firstDay: 1, // Kalendar startet mit Montag
        weekNumbers: false,       // Kalenderwochen einblenden
        weekNumbersWithinDays: false, // wichtig: nicht innerhalb der Tageszellen
        allDay: true, // nur ganze Tagesevents, keine Uhrzeit
        events: '/events',
        expandRows: true,      // Zeilen werden gestreckt statt Scroll
        eventDisplay: 'block',   // ganzt√§gige Events sch√∂ner darstellen
        dayMaxEventRows: false, // damit Events umbrechen
        eventContent: function(arg) {
          // Container
          let outerDiv = document.createElement('div');
          outerDiv.classList.add('fc-event-custom');

          // Titel (bricht automatisch um)
          let titleDiv = document.createElement('div');
          titleDiv.innerText = arg.event.title;
          titleDiv.classList.add('fc-event-title');
          outerDiv.appendChild(titleDiv);

          // Personen unten rechts
          let personsDiv = document.createElement('div'); // <-- hier anlegen
          personsDiv.classList.add('fc-event-person');    // optional CSS-Klasse
          personsDiv.innerHTML = arg.event.extendedProps.persons
              .map(p => "üë§ " + p)
              .join(" ");
          outerDiv.appendChild(personsDiv);

          return { domNodes: [outerDiv] };
        }, 

        eventDidMount: function(info) {
            info.event.allDay = true;  // alle Events als ganzt√§gig markieren
        },

        eventClick: function(info) {
            if(confirm("Event l√∂schen?")) {
                fetch(`/delete_event/${info.event.id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(() => info.event.remove()); // aus Kalender entfernen
            }
        }
    });

    
      calendar.render();

  

      // Formular-Handler
      document.getElementById("eventForm").addEventListener("submit", function(e) {
        e.preventDefault();
        
        const title = document.getElementById("title").value;
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const persons = choices.getValue(true); // gibt Array der gew√§hlten Werte zur√ºck

        
        fetch("/add_event", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, start, end_date: end, persons })
        })
        .then(res => res.json())
        .then(data => {
          console.log(data);
          calendar.refetchEvents(); // Kalender aktualisieren
          modal.style.display = "none"; // Modal nach Eintragen schlie√üen
          document.getElementById("eventForm").reset(); // Formular leeren
        });
      });
    });
  </script>
  {% endblock %}

</body>
</html>